# 端点检测门限设置详解

## 📊 双门限端点检测原理

端点检测的目标是从完整音频中找出**有效语音的起始点和终止点**，去除前后的静音部分。

---

## 🔢 门限计算方法

### 1. **能量门限（Energy Thresholds）**

#### 高能量门限 T₁（初判门限）
```python
max_energy = np.max(energy_list)  # 找到最大能量值
T₁ = max_energy × energy_high_ratio  # 默认 0.5
```

**作用：** 快速定位语音的核心区域（最响亮的部分）

**计算逻辑：**
- 遍历所有帧，计算每帧的短时能量
- 找到能量最大值 `max_energy`
- 高门限 = 最大能量 × 50%（可调）

**示例：**
```
假设 max_energy = 1000
则 T₁ = 1000 × 0.5 = 500
```

所有能量 > 500 的帧被标记为"肯定是语音"。

---

#### 低能量门限 T₂（精确定位门限）
```python
T₂ = max_energy × energy_low_ratio  # 默认 0.1
```

**作用：** 从核心区域向外扩展，找到完整的语音边界

**计算逻辑：**
- 低门限 = 最大能量 × 10%（可调）
- 比高门限更宽松，用于捕获语音的起始和结束过渡段

**示例：**
```
max_energy = 1000
T₂ = 1000 × 0.1 = 100
```

能量在 100-500 之间的帧可能是语音边界。

---

### 2. **过零率门限（ZCR Threshold）**

```python
mean_zcr = np.mean(zcr_list)  # 平均过零率
zcr_threshold = mean_zcr × zcr_threshold_ratio  # 默认 1.5
```

**作用：** 检测清音（如"s"、"sh"等高频辅音），防止漏检

**计算逻辑：**
- 计算所有帧的平均过零率
- 过零率门限 = 平均值 × 1.5倍

**为什么需要过零率？**
- 清音能量低，单靠能量门限容易漏掉
- 但清音过零率高（频繁跨越零点）
- 结合过零率可以捕获"s"、"f"、"sh"等音

**示例：**
```
mean_zcr = 20
zcr_threshold = 20 × 1.5 = 30

如果某帧过零率 > 30，即使能量低，也可能是清音
```

---

## 🎯 三步检测流程

### **第一步：高门限初判**
```python
high_energy_frames = np.where(energy_list > T₁)[0]
start_frame = high_energy_frames[0]   # 第一个高能量帧
end_frame = high_energy_frames[-1]    # 最后一个高能量帧
```

**作用：** 快速定位语音的核心区域

**示例：**
```
帧序号:  0   1   2   3   4   5   6   7   8   9  10
能量:   50  80 600 700 650 500 400 300 100  60  40
                ↑   ↑   ↑   ↑
                高能量帧（>500）

初判结果：start_frame=2, end_frame=5
```

---

### **第二步：低门限扩展**

#### 向前扩展（寻找起始点）
```python
for i in range(start_frame - 1, -1, -1):  # 从初判点向前遍历
    if energy_list[i] > T₂:               # 如果能量 > 低门限
        start_frame = i                    # 更新起始点
    else:
        break                              # 遇到低于门限的帧，停止
```

#### 向后扩展（寻找终止点）
```python
for i in range(end_frame + 1, n_frames):  # 从初判点向后遍历
    if energy_list[i] > T₂:
        end_frame = i
    else:
        break
```

**示例：**
```
帧序号:  0   1   2   3   4   5   6   7   8   9  10
能量:   50  80 600 700 650 500 400 300 100  60  40
T₂=100     ✗   ✓   ✓   ✓   ✓   ✓   ✓   ✓   ✓   ✗   ✗

向前扩展: 从帧2 → 帧1（80<100，停止）
向后扩展: 从帧5 → 帧8（100≥100，继续） → 帧9（60<100，停止）

扩展后：start_frame=2, end_frame=8
```

---

### **第三步：过零率修正（捕获清音）**

#### 向前修正
```python
for i in range(start_frame - 1, -1, -1):
    if zcr_list[i] > zcr_threshold:  # 过零率高，可能是清音
        start_frame = i
    else:
        break
```

#### 向后修正
```python
for i in range(end_frame + 1, n_frames):
    if zcr_list[i] > zcr_threshold:
        end_frame = i
    else:
        break
```

**示例：**
```
假设说"四"（sì），开头的"s"是清音：

帧序号:  0   1   2   3   4   5   6
能量:   40  60 150 600 700 500 200
过零率: 15  35  40  20  18  22  12

T₁=500, T₂=100, zcr_threshold=30

第一步：高门限初判 → 帧3-5（能量>500）
第二步：低门限扩展 → 帧2-6（能量>100）
第三步：过零率修正 → 帧1-6（帧1过零率35>30，虽然能量低但是清音"s"）

最终结果：完整捕获"sì"，包括清音"s"
```

---

## ⚙️ 参数调优指南

### 当前默认参数（config.py）
```python
ENERGY_HIGH_RATIO = 0.5   # 高能量门限：最大能量的50%
ENERGY_LOW_RATIO = 0.1    # 低能量门限：最大能量的10%
ZCR_THRESHOLD_RATIO = 1.5 # 过零率门限：平均过零率的1.5倍
```

### 调优建议

#### **问题1：语音被截断（起始或结尾丢失）**
**原因：** 门限太高

**解决方案：**
```python
ENERGY_HIGH_RATIO = 0.4   # 降低高门限（0.5 → 0.4）
ENERGY_LOW_RATIO = 0.08   # 降低低门限（0.1 → 0.08）
```

---

#### **问题2：包含太多噪音（静音部分也被检测为语音）**
**原因：** 门限太低

**解决方案：**
```python
ENERGY_HIGH_RATIO = 0.6   # 提高高门限（0.5 → 0.6）
ENERGY_LOW_RATIO = 0.15   # 提高低门限（0.1 → 0.15）
```

---

#### **问题3：清音（如"s"、"f"）被漏掉**
**原因：** 过零率门限太高

**解决方案：**
```python
ZCR_THRESHOLD_RATIO = 1.2  # 降低过零率门限（1.5 → 1.2）
```

---

## 📈 可视化示例

运行实验后，查看 `results/visualizations/endpoint_*.png`，可以看到：

1. **波形图**：原始音频，红线=起始点，绿线=终止点
2. **能量曲线**：显示每帧能量，可以观察门限效果
3. **过零率曲线**：显示过零率变化

**通过观察这些图，可以判断门限设置是否合理：**
- 如果起始点太晚/终止点太早 → 降低门限
- 如果包含太多静音 → 提高门限

---

## 🧪 实际案例

### 案例1：数字"零"的端点检测

```
原始音频长度: 32193 采样点（0.73秒）
采样率: 44100 Hz

计算结果：
- 总帧数: 73 帧
- 最大能量: 0.485
- 高能量门限 T₁ = 0.485 × 0.5 = 0.243
- 低能量门限 T₂ = 0.485 × 0.1 = 0.049

检测结果：
- 起始点: 8820 采样点（0.20秒）
- 终止点: 24255 采样点（0.55秒）
- 有效语音时长: 0.35秒

去除了：
- 前0.20秒的静音
- 后0.18秒的静音
```

### 案例2：包含清音的"四"

```
原始音频: "sì"（四）
"s"是清音，能量低但过零率高

如果只用能量门限：
- 可能只检测到"ì"（元音部分）
- "s"被漏掉 ✗

加入过零率门限后：
- 能量低但过零率高的"s"也被检测到
- 完整捕获"sì" ✓
```

---

## 💡 总结

### 门限设置的核心思想

1. **高能量门限**：定位核心（浊音、元音）
2. **低能量门限**：扩展边界（过渡段）
3. **过零率门限**：补充清音（辅音）

### 默认参数适用场景

```python
ENERGY_HIGH_RATIO = 0.5   # 适合大多数情况
ENERGY_LOW_RATIO = 0.1    # 适合安静环境录音
ZCR_THRESHOLD_RATIO = 1.5 # 适合普通话
```

### 参数调整原则

- 录音环境嘈杂 → 提高能量门限
- 说话声音小 → 降低能量门限
- 包含大量清音 → 降低过零率门限
- 调整后运行实验，观察可视化结果，迭代优化

---

**相关文件：**
- 端点检测代码: `src/audio_processing.py` (第135-230行)
- 参数配置: `config.py` (第34-36行)
- 可视化结果: `results/visualizations/endpoint_*.png`
